{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "EnvironmentCreationConfig",
  "description": "Configuration for creating a deployment environment\n\nThis is the top-level configuration object that contains all information\nneeded to create a new deployment environment. It deserializes from JSON\nconfiguration and provides type-safe conversion to domain parameters.\n\n# Examples\n\n```rust\nuse torrust_tracker_deployer_lib::application::command_handlers::create::config::{\n    EnvironmentCreationConfig, EnvironmentSection, ProviderSection, LxdProviderSection\n};\n\nlet json = r#\"{\n    \"environment\": {\n        \"name\": \"dev\"\n    },\n    \"ssh_credentials\": {\n        \"private_key_path\": \"fixtures/testing_rsa\",\n        \"public_key_path\": \"fixtures/testing_rsa.pub\"\n    },\n    \"provider\": {\n        \"provider\": \"lxd\",\n        \"profile_name\": \"torrust-profile-dev\"\n    },\n    \"tracker\": {\n        \"core\": {\n            \"database\": {\n                \"driver\": \"sqlite3\",\n                \"database_name\": \"tracker.db\"\n            },\n            \"private\": false\n        },\n        \"udp_trackers\": [\n            {\n                \"bind_address\": \"0.0.0.0:6969\"\n            }\n        ],\n        \"http_trackers\": [\n            {\n                \"bind_address\": \"0.0.0.0:7070\"\n            }\n        ],\n        \"http_api\": {\n            \"bind_address\": \"0.0.0.0:1212\",\n            \"admin_token\": \"MyAccessToken\"\n        }\n    }\n}\"#;\n\nlet config: EnvironmentCreationConfig = serde_json::from_str(json)?;\n# Ok::<(), Box<dyn std::error::Error>>(())\n```",
  "type": "object",
  "properties": {
    "environment": {
      "description": "Environment-specific settings",
      "$ref": "#/$defs/EnvironmentSection"
    },
    "provider": {
      "description": "Provider-specific configuration (LXD, Hetzner, etc.)\n\nUses `ProviderSection` for JSON parsing with raw primitives.\nConverted to domain `ProviderConfig` via `to_environment_params()`.",
      "$ref": "#/$defs/ProviderSection"
    },
    "ssh_credentials": {
      "description": "SSH credentials configuration",
      "$ref": "#/$defs/SshCredentialsConfig"
    },
    "tracker": {
      "description": "Tracker deployment configuration\n\nUses `TrackerSection` for JSON parsing with String primitives.\nConverted to domain `TrackerConfig` via `to_environment_params()`.",
      "$ref": "#/$defs/TrackerSection"
    }
  },
  "required": [
    "environment",
    "ssh_credentials",
    "provider",
    "tracker"
  ],
  "$defs": {
    "DatabaseSection": {
      "description": "Database configuration section (application DTO)\n\nMirrors the domain `DatabaseConfig` enum but at the application layer.\nSupports both `SQLite` and `MySQL` database backends.\n\n# Examples\n\n```json\n{\n  \"driver\": \"sqlite3\",\n  \"database_name\": \"tracker.db\"\n}\n```\n\n```json\n{\n  \"driver\": \"mysql\",\n  \"host\": \"localhost\",\n  \"port\": 3306,\n  \"database_name\": \"tracker\",\n  \"username\": \"tracker_user\",\n  \"password\": \"secure_password\"\n}\n```",
      "oneOf": [
        {
          "description": "`SQLite` file-based database",
          "type": "object",
          "properties": {
            "database_name": {
              "description": "Database file name",
              "type": "string"
            },
            "driver": {
              "type": "string",
              "const": "sqlite3"
            }
          },
          "required": [
            "driver",
            "database_name"
          ]
        },
        {
          "description": "`MySQL` server-based database",
          "type": "object",
          "properties": {
            "database_name": {
              "description": "Database name",
              "type": "string"
            },
            "driver": {
              "type": "string",
              "const": "mysql"
            },
            "host": {
              "description": "`MySQL` server host",
              "type": "string"
            },
            "password": {
              "description": "Database password (plain text during DTO serialization/deserialization)\n\nUses `PlainPassword` type alias to explicitly mark this as a temporarily visible secret.\nConverted to secure `Password` type in `to_database_config()` at the DTO-to-domain boundary.",
              "type": "string"
            },
            "port": {
              "description": "`MySQL` server port",
              "type": "integer",
              "format": "uint16",
              "maximum": 65535,
              "minimum": 0
            },
            "username": {
              "description": "Database username",
              "type": "string"
            }
          },
          "required": [
            "driver",
            "host",
            "port",
            "database_name",
            "username",
            "password"
          ]
        }
      ]
    },
    "EnvironmentSection": {
      "description": "Environment-specific configuration section\n\nContains configuration specific to the environment being created.",
      "type": "object",
      "properties": {
        "instance_name": {
          "description": "Optional custom instance name for the VM/container\n\nIf not provided, auto-generated as `torrust-tracker-vm-{env_name}`.\nWhen provided, must follow instance naming rules:\n- 1-63 characters\n- ASCII letters, numbers, and dashes only\n- Cannot start with digit or dash\n- Cannot end with dash",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "name": {
          "description": "Name of the environment to create\n\nMust follow environment naming rules:\n- Lowercase letters and numbers only\n- Dashes as word separators\n- Cannot start or end with separators\n- Cannot start with numbers",
          "type": "string"
        }
      },
      "required": [
        "name"
      ]
    },
    "HetznerProviderSection": {
      "description": "Hetzner-specific configuration section\n\nUses raw `String` fields for JSON deserialization. Convert to domain\n`HetznerConfig` via `ProviderSection::to_provider_config()`.\n\n# Examples\n\n```rust\nuse torrust_tracker_deployer_lib::application::command_handlers::create::config::HetznerProviderSection;\n\nlet section = HetznerProviderSection {\n    api_token: \"your-api-token\".to_string(),\n    server_type: \"cx22\".to_string(),\n    location: \"nbg1\".to_string(),\n    image: \"ubuntu-24.04\".to_string(),\n};\n```",
      "type": "object",
      "properties": {
        "api_token": {
          "description": "Hetzner API token in plain text format (DTO layer).\n\nThis uses [`PlainApiToken`] to mark it as a transparent secret during\ndeserialization. Convert to domain `ApiToken` at the DTO-to-domain boundary.",
          "type": "string"
        },
        "image": {
          "description": "Hetzner server image (e.g., \"ubuntu-24.04\", \"ubuntu-22.04\", \"debian-12\").",
          "type": "string"
        },
        "location": {
          "description": "Hetzner datacenter location (e.g., \"fsn1\", \"nbg1\", \"hel1\").",
          "type": "string"
        },
        "server_type": {
          "description": "Hetzner server type (e.g., \"cx22\", \"cx32\", \"cpx11\").",
          "type": "string"
        }
      },
      "required": [
        "api_token",
        "server_type",
        "location",
        "image"
      ]
    },
    "HttpApiSection": {
      "type": "object",
      "properties": {
        "admin_token": {
          "type": "string"
        },
        "bind_address": {
          "type": "string"
        }
      },
      "required": [
        "bind_address",
        "admin_token"
      ]
    },
    "HttpTrackerSection": {
      "type": "object",
      "properties": {
        "bind_address": {
          "type": "string"
        }
      },
      "required": [
        "bind_address"
      ]
    },
    "LxdProviderSection": {
      "description": "LXD-specific configuration section\n\nUses raw `String` for JSON deserialization. Convert to domain `LxdConfig`\nvia `ProviderSection::to_provider_config()`.\n\n# Examples\n\n```rust\nuse torrust_tracker_deployer_lib::application::command_handlers::create::config::LxdProviderSection;\n\nlet section = LxdProviderSection {\n    profile_name: \"torrust-profile-dev\".to_string(),\n};\n```",
      "type": "object",
      "properties": {
        "profile_name": {
          "description": "LXD profile name (raw string - validated on conversion).",
          "type": "string"
        }
      },
      "required": [
        "profile_name"
      ]
    },
    "ProviderSection": {
      "description": "Provider-specific configuration section\n\nEach variant contains the configuration fields specific to that provider\nusing **raw primitives** (`String`) for JSON deserialization.\n\nThis is a tagged enum that deserializes based on the `\"provider\"` field in JSON.\n\n# Conversion\n\nUse `to_provider_config()` to validate and convert to domain types.\n\n# Examples\n\n```rust\nuse torrust_tracker_deployer_lib::application::command_handlers::create::config::{\n    ProviderSection, LxdProviderSection\n};\n\nlet section = ProviderSection::Lxd(LxdProviderSection {\n    profile_name: \"torrust-profile-dev\".to_string(),\n});\n\nlet config = section.to_provider_config().unwrap();\nassert_eq!(config.provider_name(), \"lxd\");\n```",
      "oneOf": [
        {
          "description": "LXD provider configuration",
          "type": "object",
          "properties": {
            "provider": {
              "type": "string",
              "const": "lxd"
            }
          },
          "$ref": "#/$defs/LxdProviderSection",
          "required": [
            "provider"
          ]
        },
        {
          "description": "Hetzner provider configuration",
          "type": "object",
          "properties": {
            "provider": {
              "type": "string",
              "const": "hetzner"
            }
          },
          "$ref": "#/$defs/HetznerProviderSection",
          "required": [
            "provider"
          ]
        }
      ]
    },
    "SshCredentialsConfig": {
      "description": "SSH credentials configuration for remote instance authentication\n\nThis is a configuration-layer value object that uses strings for paths\nand username. It is distinct from `adapters::ssh::SshCredentials` which\nuses domain types (`PathBuf`, `Username`).\n\n# Examples\n\n```no_run\nuse torrust_tracker_deployer_lib::application::command_handlers::create::config::SshCredentialsConfig;\n\nlet config = SshCredentialsConfig {\n    private_key_path: \"fixtures/testing_rsa\".to_string(),\n    public_key_path: \"fixtures/testing_rsa.pub\".to_string(),\n    username: \"torrust\".to_string(),\n    port: 22,\n};\n```",
      "type": "object",
      "properties": {
        "port": {
          "description": "SSH port for remote connections\n\nDefaults to 22 (standard SSH port) if not specified in configuration.",
          "type": "integer",
          "format": "uint16",
          "default": 22,
          "maximum": 65535,
          "minimum": 0
        },
        "private_key_path": {
          "description": "Path to the SSH private key file (as string in config)",
          "type": "string"
        },
        "public_key_path": {
          "description": "Path to the SSH public key file (as string in config)",
          "type": "string"
        },
        "username": {
          "description": "SSH username (as string in config)\n\nDefaults to \"torrust\" if not specified in configuration.",
          "type": "string",
          "default": "torrust"
        }
      },
      "required": [
        "private_key_path",
        "public_key_path"
      ]
    },
    "TrackerCoreSection": {
      "description": "Tracker core configuration section (application DTO)\n\nContains core tracker settings like database and privacy mode.\n\n# Examples\n\n```json\n{\n  \"database\": {\n    \"driver\": \"sqlite3\",\n    \"database_name\": \"tracker.db\"\n  },\n  \"private\": false\n}\n```",
      "type": "object",
      "properties": {
        "database": {
          "description": "Database configuration",
          "$ref": "#/$defs/DatabaseSection"
        },
        "private": {
          "description": "Privacy mode: true for private tracker, false for public",
          "type": "boolean"
        }
      },
      "required": [
        "database",
        "private"
      ]
    },
    "TrackerSection": {
      "description": "Tracker configuration section (application DTO)\n\nAggregates all tracker configuration sections: core, UDP trackers,\nHTTP trackers, and HTTP API.\n\n# Examples\n\n```json\n{\n  \"core\": {\n    \"database\": {\n      \"driver\": \"sqlite3\",\n      \"database_name\": \"tracker.db\"\n    },\n    \"private\": false\n  },\n  \"udp_trackers\": [\n    { \"bind_address\": \"0.0.0.0:6969\" }\n  ],\n  \"http_trackers\": [\n    { \"bind_address\": \"0.0.0.0:7070\" }\n  ],\n  \"http_api\": {\n    \"bind_address\": \"0.0.0.0:1212\",\n    \"admin_token\": \"MyAccessToken\"\n  }\n}\n```",
      "type": "object",
      "properties": {
        "core": {
          "description": "Core tracker configuration (database, privacy mode)",
          "$ref": "#/$defs/TrackerCoreSection"
        },
        "http_api": {
          "description": "HTTP API configuration",
          "$ref": "#/$defs/HttpApiSection"
        },
        "http_trackers": {
          "description": "HTTP tracker instances",
          "type": "array",
          "items": {
            "$ref": "#/$defs/HttpTrackerSection"
          }
        },
        "udp_trackers": {
          "description": "UDP tracker instances",
          "type": "array",
          "items": {
            "$ref": "#/$defs/UdpTrackerSection"
          }
        }
      },
      "required": [
        "core",
        "udp_trackers",
        "http_trackers",
        "http_api"
      ]
    },
    "UdpTrackerSection": {
      "type": "object",
      "properties": {
        "bind_address": {
          "type": "string"
        }
      },
      "required": [
        "bind_address"
      ]
    }
  }
}