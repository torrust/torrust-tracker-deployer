# YAML Template Conventions

This document describes conventions for Tera templates that generate YAML files in the Torrust Tracker Deployer project.

> **See Also**: For general Tera template syntax, see [Tera Template Guide](tera.md). For architectural details, see [Template System Architecture](template-system-architecture.md).

## ğŸ“‹ Header Placement Convention

**CRITICAL**: For YAML templates (both `.yml.tera` and static `.yml` files), the AI-discoverable documentation header MUST be placed **BEFORE** the `---` YAML document marker.

### âœ… Correct Header Placement

```yaml
# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
# Generated at: {{ generated_at }}
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/variables.yml.tera
#   Rust Wrapper:  src/infrastructure/templating/ansible/template/wrappers/variables/context.rs
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Centralized Ansible variables used across playbooks for system configuration.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# YAML content starts here
variable_name: { { value } }
```

### âŒ Incorrect Header Placement

```yaml
---
# âŒ WRONG - Header after the document marker
# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
```

### ğŸ“ Rationale

The `---` marker in YAML indicates the **start of a YAML document**. The header contains **metadata about the file** (repository links, generation info, documentation), not YAML content. Therefore:

1. **Header = Metadata** â†’ Comes first
2. **`---` = Document Start** â†’ Comes after metadata
3. **YAML Content** â†’ Comes after document marker

This convention ensures:

- Clear separation between metadata and content
- Consistency across all YAML templates (dynamic `.tera` and static)
- Proper YAML document structure
- AI agents can discover documentation before parsing YAML

### ğŸ“‚ Files Following This Convention

**Dynamic Templates** (`.yml.tera`):

- `templates/ansible/variables.yml.tera`
- `templates/ansible/inventory.yml.tera`
- `templates/grafana/provisioning/datasources/prometheus.yml.tera`
- `templates/prometheus/prometheus.yml.tera`
- `templates/tofu/common/cloud-init.yml.tera`

**Static Templates** (`.yml`):

- `templates/ansible/configure-firewall.yml`
- `templates/ansible/configure-security-updates.yml`
- `templates/ansible/create-grafana-storage.yml`
- And all other Ansible playbooks...

## ğŸ¯ YAML-Specific Tera Patterns

### Control Flow with Whitespace Control

When using Tera control flow in YAML templates, use `{%-` to prevent inserting extra blank lines:

```yaml
# âœ… GOOD - No extra blank lines
services:
{%- if mysql_enabled %}
  mysql:
    image: mysql:8.0
{%- endif %}
{%- if grafana_enabled %}
  grafana:
    image: grafana/grafana:latest
{%- endif %}
```

```yaml
# âŒ BAD - Creates blank lines between services
services:
{% if mysql_enabled %}
  mysql:
    image: mysql:8.0
{% endif %}
{% if grafana_enabled %}
  grafana:
    image: grafana/grafana:latest
{% endif %}
```

**Result of bad approach**:

```yaml
services:
  mysql:
    image: mysql:8.0

  grafana:
    image: grafana/grafana:latest
```

### Conditional Indentation

YAML is indentation-sensitive. When using conditionals, ensure proper indentation:

```yaml
# âœ… CORRECT - Maintains proper YAML indentation
networks:
{%- if database_enabled %}
  db_network:
    driver: bridge
{%- endif %}
{%- if metrics_enabled %}
  metrics_network:
    driver: bridge
{%- endif %}
```

### List Items with Templates

When generating YAML lists with Tera:

```yaml
# âœ… CORRECT - Consistent list formatting
hosts:
{%- for host in inventory_hosts %}
  - name: {{ host.name }}
    address: {{ host.ip }}
{%- endfor %}
```

### Multi-line Strings

YAML supports multi-line strings. Be careful with Tera variable placement:

```yaml
# âœ… CORRECT - Preserves YAML multi-line syntax
description: |
  {{ service_description }}

  Additional context goes here.

# âœ… CORRECT - Folded scalar
summary: >
  {{ short_summary }}
  continues on next line
```

## ğŸ” Common Pitfalls

### Pitfall 1: Wrong Document Marker Placement

```yaml
# âŒ WRONG
---
# Header comments after document marker
```

**Fix**: Move header before `---`

### Pitfall 2: Extra Blank Lines from Control Flow

```yaml
# âŒ WRONG
{% if condition %}
  key: value
{% endif %}
```

**Fix**: Use `{%-` and `-%}` for whitespace control

### Pitfall 3: Breaking YAML Indentation

```yaml
# âŒ WRONG - Incorrect indentation
parent:
{% if condition %}
child: value
{% endif %}
```

**Fix**: Maintain consistent indentation inside control blocks

### Pitfall 4: Unquoted Special Characters

```yaml
# âŒ RISKY - May break if variable contains YAML special chars
description: {{ user_description }}

# âœ… SAFER - Quote the value
description: "{{ user_description }}"
```

## ğŸ“š Best Practices

### 1. Validate Rendered Output

Always check the rendered YAML in the `build/` directory:

```bash
# Check rendered Ansible variables
cat build/your-env/ansible/variables.yml

# Validate YAML syntax
yamllint build/your-env/ansible/variables.yml
```

### 2. Use Comments for User Guidance

Add comments to explain configuration options:

```yaml
# Set to true when ANY HTTP tracker uses Caddy TLS termination
caddy_enabled: { { caddy_enabled } }

# HTTP tracker external port (must match your Caddy configuration)
http_tracker_port: { { http_tracker_port } }
```

### 3. Group Related Configuration

Organize YAML content logically:

```yaml
# Database Configuration
mysql_enabled: { { mysql_enabled } }
mysql_root_password: "{{ mysql_root_password }}"

# Monitoring Configuration
prometheus_enabled: { { prometheus_enabled } }
grafana_enabled: { { grafana_enabled } }
```

### 4. Whitespace Control Strategy

- Use `{%-` at start of control flow to trim preceding whitespace
- Use `-%}` at end only when needed to prevent trailing blank lines
- Test rendered output to ensure no extra blank lines

## ğŸ”— Related Documentation

- [Tera Template Variable Syntax](tera.md)
- [Ansible Template Conventions](ansible.md)
- [Template System Architecture](template-system-architecture.md)
- [Issue #308 - AI-Discoverable Headers](../../issues/308-add-ai-discoverable-documentation-headers-to-templates.md)

## ğŸ“– External References

- [YAML Specification](https://yaml.org/spec/1.2.2/)
- [Tera Documentation](https://keats.github.io/tera/)
- [yamllint Documentation](https://yamllint.readthedocs.io/)
