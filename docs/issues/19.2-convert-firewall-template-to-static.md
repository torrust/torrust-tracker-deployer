# Convert Firewall Template to Static

**Issue**: #19.2
**Parent Epic**: #19 - Refactor Ansible Templates to Variables Pattern
**Depends On**: #19.1 - Create Variables Template
**Related**: [Parent Epic](./19-refactor-ansible-templates-variables-pattern.md), [Issue #19.1](./19.1-create-variables-template.md)

## Overview

Convert the `configure-firewall.yml.tera` template to a static `configure-firewall.yml` playbook that loads variables from the centralized `variables.yml` file. This demonstrates the variables pattern in action and simplifies the firewall playbook infrastructure by eliminating the need for dedicated renderer components.

## Goals

- [ ] **Template Conversion**: Convert `.tera` template to static `.yml` playbook
- [ ] **Variables Integration**: Add `vars_files: [variables.yml]` to load centralized variables
- [ ] **Static Registration**: Register playbook in `copy_static_templates()` method
- [ ] **Renderer Cleanup**: Remove firewall playbook rendering from main workflow
- [ ] **AnsibleClient Enhancement**: Make generic to accept optional extra arguments
- [ ] **Call Site Updates**: Update all AnsibleClient call sites for new signature

## 🏗️ Architecture Requirements

**DDD Layer**: Infrastructure (template system) + Adapters (AnsibleClient)
**Module Paths**:

- `templates/ansible/` - Template files
- `src/infrastructure/external_tools/ansible/template/renderer/mod.rs` - Static registration
- `src/adapters/ansible/mod.rs` - AnsibleClient
- `src/application/steps/system/configure_firewall.rs` - Step implementation

**Pattern**: Static template copying + Ansible vars_files

### Module Structure Requirements

- [ ] Static templates registered explicitly in `copy_static_templates()`
- [ ] AnsibleClient remains generic and flexible
- [ ] Step implementations use clean, explicit API

### Architectural Constraints

- [ ] Template file must NOT have `.tera` extension (static file)
- [ ] Playbook uses Ansible's `vars_files` directive (not Tera variables)
- [ ] AnsibleClient signature change is backward compatible via default args
- [ ] No business logic in AnsibleClient (pure adapter)

### Anti-Patterns to Avoid

- ❌ Hardcoding `-e @variables.yml` in AnsibleClient
- ❌ Breaking existing call sites without migration
- ❌ Mixing template rendering logic in AnsibleClient

## Specifications

### Convert Template File

**Before**: `templates/ansible/configure-firewall.yml.tera`

```yaml
---
- name: Configure UFW firewall safely
  hosts: all
  become: yes
  gather_facts: yes
  # Variables come from Tera rendering: {{ ssh_port }}
```

**After**: `templates/ansible/configure-firewall.yml` (no `.tera` extension)

```yaml
---
# Configure UFW Firewall with Safe SSH Access
# Variables are loaded from variables.yml for centralized management.

- name: Configure UFW firewall safely
  hosts: all
  become: yes
  gather_facts: yes
  vars_files:
    - variables.yml # ← ADD THIS LINE

  tasks:
    # All {{ssh_port}} references work via Ansible vars_files
    - name: Allow SSH access on configured port
      community.general.ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
        comment: "SSH access (port {{ ssh_port }})"
```

### Register as Static Template

**File**: `src/infrastructure/external_tools/ansible/template/renderer/mod.rs`

**Update**: Add to `copy_static_templates()` method:

```rust
// Copy all playbook files
for playbook in &[
    "update-apt-cache.yml",
    "install-docker.yml",
    "install-docker-compose.yml",
    "wait-cloud-init.yml",
    "configure-security-updates.yml",
    "configure-firewall.yml",  // ← ADD THIS
] {
    self.copy_static_file(template_manager, playbook, destination_dir)
        .await?;
}

tracing::debug!(
    "Successfully copied {} static template files",
    7 // ansible.cfg + 6 playbooks  ← UPDATE COUNT
);
```

### Remove Firewall Renderer Usage

**File**: `src/infrastructure/external_tools/ansible/template/renderer/mod.rs`

**Remove**:

1. `firewall_playbook_renderer` field from struct
2. Firewall renderer initialization in constructor
3. Firewall rendering call from `render()` method
4. `create_firewall_context()` helper method
5. `FirewallPlaybookRenderingFailed` error variant

### Update AnsibleClient Signature

**File**: `src/adapters/ansible/mod.rs`

**Current**:

```rust
pub fn run_playbook(&self, playbook_name: &str) -> Result<(), CommandError>
```

**Updated**:

````rust
/// Run an Ansible playbook with optional extra arguments
///
/// # Arguments
///
/// * `playbook_name` - Name of the playbook (e.g., "configure-firewall.yml")
/// * `extra_args` - Optional extra arguments to pass to ansible-playbook
///
/// # Examples
///
/// ```rust
/// // Run without extra args (backward compatible)
/// client.run_playbook("install-docker.yml", &[])?;
///
/// // Run with extra variables
/// client.run_playbook("configure-firewall.yml", &["-e", "@variables.yml"])?;
/// ```
pub fn run_playbook(&self, playbook_name: &str, extra_args: &[&str]) -> Result<(), CommandError> {
    let mut cmd = Command::new("ansible-playbook");

    cmd.arg("-i").arg(&self.inventory_path)
       .arg(playbook_name);

    // Add any extra arguments
    for arg in extra_args {
        cmd.arg(arg);
    }

    // ... rest of existing execution logic
}
````

### Update ConfigureFirewallStep

**File**: `src/application/steps/system/configure_firewall.rs`

**Update** to pass variables file:

```rust
pub fn execute(&self) -> Result<(), CommandError> {
    warn!("Configuring UFW firewall with variables from variables.yml");

    // Pass variables file to Ansible
    // Note: The @ symbol in Ansible means "load variables from this file"
    // Equivalent to: ansible-playbook -e @variables.yml configure-firewall.yml
    self.ansible_client
        .run_playbook("configure-firewall", &["-e", "@variables.yml"])
        .map_err(|e| CommandError::AnsibleExecution(e))?;

    info!("UFW firewall configured successfully");
    Ok(())
}
```

## Implementation Plan

This task builds on #19.1 (variables template must exist). Each step maintains green tests.

### Phase 1: Prepare Template File (0.25 days)

**Safe Steps**:

1. Copy `templates/ansible/configure-firewall.yml.tera` → `configure-firewall.yml` (keep both temporarily)
2. Remove `.tera` extension from the copy
3. Add `vars_files: [variables.yml]` at playbook level
4. Verify YAML syntax: `cargo run --bin linter yaml`
5. Commit: "feat: [#19.2] create static firewall playbook with vars_files"

**Green Check**: Linters pass, both templates exist (old one still used).

### Phase 2: Register Static Template (0.25 days)

**Safe Steps**:

1. Update `copy_static_templates()` in `renderer/mod.rs`
2. Add `"configure-firewall.yml"` to playbook list
3. Update file count in debug log (6 → 7)
4. Run config tests: `cargo run --bin e2e-config-tests`
5. Verify `build/e2e-config/ansible/configure-firewall.yml` exists (static copy)
6. Commit: "feat: [#19.2] register firewall playbook as static template"

**Green Check**: Config tests pass, static file copied correctly.

### Phase 3: Update AnsibleClient Signature (0.5 days)

**Safe Steps**:

1. Update `run_playbook()` signature to accept `extra_args: &[&str]`
2. Add parameter to command construction logic
3. Update rustdoc with examples
4. Build project: `cargo build` (will fail - expected)
5. Find all call sites: `grep -r "run_playbook" src/`
6. Commit: "feat: [#19.2] add extra_args parameter to AnsibleClient::run_playbook"

**Red State**: Compilation fails - this is expected and temporary.

### Phase 4: Update All Call Sites (0.5 days)

**Safe Steps**:

1. Update each `run_playbook()` call to pass `&[]` for empty args:

   ```rust
   // Old
   self.ansible_client.run_playbook("install-docker.yml")?;

   // New
   self.ansible_client.run_playbook("install-docker.yml", &[])?;
   ```

2. Update these files systematically:
   - `src/application/steps/system/install_docker.rs`
   - `src/application/steps/system/install_docker_compose.rs`
   - `src/application/steps/system/configure_security_updates.rs`
   - Any other step that calls `run_playbook()`
3. Build after each file: `cargo build`
4. Run tests after all updates: `cargo test`
5. Commit: "feat: [#19.2] update all AnsibleClient call sites to new signature"

**Green Check**: Project compiles, all tests pass.

### Phase 5: Update ConfigureFirewallStep (0.25 days)

**Safe Steps**:

1. Update firewall step to pass variables file
2. Change call to: `run_playbook("configure-firewall", &["-e", "@variables.yml"])`
   - Note: The `@` symbol tells Ansible to load variables from a file
   - See [Ansible documentation](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html) for details
3. Run unit tests: `cargo test`
4. Run config tests: `cargo run --bin e2e-config-tests`
5. Verify firewall still runs (may have warning about variables file)
6. Commit: "feat: [#19.2] configure firewall step to use centralized variables"

**Green Check**: Tests pass, firewall step updated.

### Phase 6: Remove Old Template Rendering (0.5 days)

**Safe Steps**:

1. Remove `firewall_playbook_renderer` field from `AnsibleTemplateRenderer`
2. Remove renderer initialization in constructor
3. Remove firewall rendering call from `render()` method
4. Remove `create_firewall_context()` helper
5. Remove `FirewallPlaybookRenderingFailed` error variant
6. Build project: `cargo build`
7. Run tests: `cargo test`
8. Run config tests: `cargo run --bin e2e-config-tests`
9. Commit: "feat: [#19.2] remove firewall playbook rendering from workflow"

**Green Check**: Builds, tests pass, firewall no longer rendered as Tera template.

### Phase 7: Delete Old Template File (0.25 days)

**Safe Steps**:

1. Delete `templates/ansible/configure-firewall.yml.tera`
2. Run linters: `cargo run --bin linter all`
3. Run config tests: `cargo run --bin e2e-config-tests`
4. Verify static `configure-firewall.yml` is copied to build dir
5. Verify it contains `vars_files: [variables.yml]`
6. Commit: "feat: [#19.2] delete old firewall template file"

**Green Check**: All tests pass, only static template exists.

### Phase 8: Final Validation (0.25 days)

**Safe Steps**:

1. Run all tests: `cargo test`
2. Run config tests: `cargo run --bin e2e-config-tests`
3. Run linters: `cargo run --bin linter all`
4. Manually verify build directory structure:
   - `build/e2e-config/ansible/variables.yml` exists (from #19.1)
   - `build/e2e-config/ansible/configure-firewall.yml` exists (static copy)
   - File contains `vars_files: [variables.yml]`
5. Verify no references to `.tera` version: `grep -r "configure-firewall.yml.tera" src/`
6. Commit: "feat: [#19.2] finalize firewall template conversion"

**Green Check**: All systems green, conversion complete.

---

**Note**: The following phases (9-11) complete the vertical slice by adding cleanup, documentation, and comprehensive validation. This ensures the task is truly complete and deployable.

---

## Acceptance Criteria

### Quality Checks

- [ ] Pre-commit checks pass: `./scripts/pre-commit.sh`

### Template Conversion

- [ ] `configure-firewall.yml` exists (no `.tera` extension)
- [ ] Contains `vars_files: [variables.yml]` directive
- [ ] All `{{ ssh_port }}` references use Ansible variables (not Tera)
- [ ] Old `.tera` file deleted
- [ ] YAML linting passes

### Static Registration

- [ ] Playbook registered in `copy_static_templates()` method
- [ ] File count updated in debug log
- [ ] Config tests copy file to build directory
- [ ] Static file appears in `build/e2e-config/ansible/`

### Renderer Cleanup

- [ ] `firewall_playbook_renderer` field removed from struct
- [ ] Renderer initialization removed from constructor
- [ ] Firewall rendering removed from `render()` method
- [ ] Helper method `create_firewall_context()` deleted
- [ ] Error variant `FirewallPlaybookRenderingFailed` deleted
- [ ] No compilation errors after removal

### AnsibleClient Enhancement

- [ ] `run_playbook()` accepts `extra_args: &[&str]` parameter
- [ ] Extra args properly passed to command construction
- [ ] Rustdoc updated with examples
- [ ] All existing call sites updated to pass `&[]`

### ConfigureFirewallStep

- [ ] Step passes variables file: `&["-e", "@variables.yml"]`
- [ ] Unit tests pass
- [ ] Config tests pass

### Integration

- [ ] All unit tests pass: `cargo test`
- [ ] Config tests pass: `cargo run --bin e2e-config-tests`
- [ ] Linters pass: `cargo run --bin linter all`
- [ ] No references to old `.tera` template
- [ ] Firewall configuration works with centralized variables

## Phase 9: Clean Up Old Firewall Architecture (2-3 hours)

**Goal**: Remove obsolete firewall renderer and wrapper code now that static approach is proven working.

### Step 9.1: Delete Firewall Renderer Module

**Delete**: `src/infrastructure/external_tools/ansible/template/renderer/firewall_playbook.rs`

**Verification**:

```bash
# File should not exist
ls src/infrastructure/external_tools/ansible/template/renderer/firewall_playbook.rs
# Expected: No such file or directory
```

### Step 9.2: Delete Firewall Wrapper Directory

**Delete**: `src/infrastructure/external_tools/ansible/template/wrappers/firewall_playbook/` (entire directory)

**Verification**:

```bash
# Directory should not exist
ls src/infrastructure/external_tools/ansible/template/wrappers/firewall_playbook/
# Expected: No such file or directory
```

### Step 9.3: Remove Module Exports

**File**: `src/infrastructure/external_tools/ansible/template/renderer/mod.rs`

Remove:

```rust
pub mod firewall_playbook;  // ← DELETE THIS LINE
pub use firewall_playbook::FirewallPlaybookTemplateRenderer;  // ← DELETE THIS LINE
```

**File**: `src/infrastructure/external_tools/ansible/template/wrappers/mod.rs`

Remove:

```rust
pub mod firewall_playbook;  // ← DELETE THIS LINE
pub use firewall_playbook::FirewallPlaybookTemplate;  // ← DELETE THIS LINE
```

### Step 9.4: Verify No Remaining References

Run comprehensive searches:

```bash
# Should return NO matches (except in docs/issues/)
grep -r "firewall_playbook" src/
grep -r "FirewallPlaybookTemplate" src/
grep -r "FirewallPlaybookContext" src/
grep -r "FirewallPlaybookTemplateRenderer" src/
```

**Green Check**: All grep commands return zero matches in `src/` directory.

### Step 9.5: Verify All Tests Pass

```bash
cargo test
cargo run --bin e2e-config-tests
cargo run --bin linter all
```

**Green Check**: All tests pass without the deleted components.

### Acceptance Criteria - Phase 9

- [ ] `firewall_playbook.rs` deleted (~350 lines removed)
- [ ] `wrappers/firewall_playbook/` directory deleted (~150 lines removed)
- [ ] Module exports removed from both parent modules
- [ ] No references to deleted components in `src/` (verified by grep)
- [ ] All tests pass: `cargo test`
- [ ] Config tests pass: `cargo run --bin e2e-config-tests`
- [ ] Linters pass: `cargo run --bin linter all`
- [ ] ~500+ lines of boilerplate eliminated

## Phase 10: Update Documentation (1-2 hours)

**Goal**: Update project documentation to reflect the new variables pattern and remove references to old architecture.

### Step 10.1: Update Template System Architecture

**File**: `docs/technical/template-system-architecture.md`

Add section explaining variables pattern:

```markdown
### Ansible Variables Pattern

For Ansible templates, the system uses a **hybrid approach**:

**Tera Templates** (2 templates):

1. `inventory.yml.tera` - Inventory requires direct variable substitution (Ansible inventories don't support vars_files)
2. `variables.yml.tera` - Centralized variables for all playbooks

**Static Templates** (playbooks):

- All playbooks are static YAML files
- Playbooks reference variables via `vars_files: [variables.yml]`
- Variables resolved at Ansible runtime

**Benefits**:

- Reduced Rust boilerplate (no per-playbook renderers needed)
- Centralized variable management for playbooks
- Consistent with OpenTofu's `variables.tfvars.tera` pattern
```

### Step 10.2: Update Contributing Templates Guide

**File**: `docs/contributing/templates.md`

Add section about using centralized variables:

````markdown
### Using Centralized Variables in Playbooks

When creating new Ansible playbooks that need dynamic variables (ports, paths, etc.):

**DO**:

- ✅ Add variables to `templates/ansible/variables.yml.tera`
- ✅ Reference variables in playbook using `vars_files: [variables.yml]`
- ✅ Keep playbook as static `.yml` file

**DON'T**:

- ❌ Create a new `.tera` template for the playbook
- ❌ Create a new renderer/wrapper/context for each playbook
- ❌ Add variables directly in inventory.yml.tera (unless inventory-specific)

**Example**:

```yaml
# templates/ansible/my-new-service.yml
---
- name: Configure My Service
  hosts: all
  vars_files:
    - variables.yml # Load centralized variables

  tasks:
    - name: Configure service port
      lineinfile:
        path: /etc/myservice/config
        line: "port={{ my_service_port }}"
```

Then add to `variables.yml.tera`:

```yaml
# System Configuration
ssh_port: { { ssh_port } }
my_service_port: { { my_service_port } } # ← Add new variable
```
````

### Step 10.3: Update Templates README

**File**: `templates/ansible/README.md`

Update to document the variables pattern:

```markdown
## Variables Pattern

This directory uses a **centralized variables pattern**:

- `variables.yml.tera` - Centralized variables (rendered at runtime)
- `inventory.yml.tera` - Connection variables (rendered at runtime)
- `*.yml` - Static playbooks that load `variables.yml`

When adding new playbooks:

1. Add variables to `variables.yml.tera`
2. Create static `.yml` playbook (not `.tera`)
3. Add `vars_files: [variables.yml]` to playbook
4. Register in `copy_static_templates()` if new
```

### Acceptance Criteria - Phase 10

- [ ] Template system architecture doc updated with variables pattern explanation
- [ ] Contributing templates guide updated with DO/DON'T examples
- [ ] Templates README updated with variables pattern overview
- [ ] All documentation changes reviewed for accuracy
- [ ] Markdown linter passes: `cargo run --bin linter markdown`

## Phase 11: Final Integration Validation (30 minutes - 1 hour)

**Goal**: Comprehensive validation that everything works together.

### Step 11.1: Run Full Test Suite

```bash
# Unit tests
cargo test

# Config tests (validates template structure)
cargo run --bin e2e-config-tests

# All linters
cargo run --bin linter all

# Documentation builds
cargo doc --no-deps --bins --examples --workspace --all-features
```

**Green Check**: All commands complete successfully.

### Step 11.2: Verify Build Directory Structure

Check `build/e2e-config/ansible/` contains:

```bash
ls -la build/e2e-config/ansible/
# Should see:
# - variables.yml (generated from variables.yml.tera)
# - inventory.yml (generated from inventory.yml.tera)
# - configure-firewall.yml (copied as static file)
# - other static playbooks...
```

### Step 11.3: Verify Template Contents

```bash
# Variables file should have resolved SSH port
cat build/e2e-config/ansible/variables.yml
# Should show: ssh_port: 22 (or configured value)

# Firewall playbook should reference variables file
grep "vars_files" build/e2e-config/ansible/configure-firewall.yml
# Should show: vars_files: [variables.yml] or similar
```

### Step 11.4: E2E Test Preparation (Human Reviewer)

**Note**: Full E2E tests require LXD/VM infrastructure and must be run by human reviewer.

**Verification Points**:

- [ ] UFW firewall configures correctly
- [ ] Variables loaded from centralized `variables.yml`
- [ ] SSH connectivity maintained throughout deployment
- [ ] No regressions in deployment workflow

### Acceptance Criteria - Phase 11

- [ ] All unit tests pass: `cargo test`
- [ ] Config tests pass: `cargo run --bin e2e-config-tests`
- [ ] All linters pass: `cargo run --bin linter all`
- [ ] Documentation builds: `cargo doc`
- [ ] Build directory structure verified
- [ ] Template contents verified (variables resolved, playbook uses vars_files)
- [ ] No compilation errors or warnings
- [ ] (Human only) Full E2E tests pass

## Complete Acceptance Criteria

### Template Conversion

- [ ] `configure-firewall.yml` is static (no `.tera` extension)
- [ ] Playbook contains `vars_files: [variables.yml]`
- [ ] Playbook registered in `copy_static_templates()`
- [ ] Old `.tera` template deleted

### API Updates

- [ ] `AnsibleClient::run_playbook()` accepts `extra_args` parameter
- [ ] All call sites updated to new signature
- [ ] Firewall step passes `&["-e", "@variables.yml"]`
- [ ] API documented with examples

### Cleanup

- [ ] `firewall_playbook.rs` renderer deleted (~350 lines)
- [ ] `wrappers/firewall_playbook/` directory deleted (~150 lines)
- [ ] Module exports removed
- [ ] No dead code or orphaned tests
- [ ] ~500+ lines of boilerplate eliminated

### Documentation

- [ ] Template system architecture updated
- [ ] Contributing templates guide updated
- [ ] Templates README updated
- [ ] Examples provided for future developers

### Testing & Validation

- [ ] Unit tests pass
- [ ] Config tests pass
- [ ] Linters pass
- [ ] Documentation builds
- [ ] Build directory structure correct
- [ ] Template contents verified
- [ ] (Human only) E2E tests pass

## Related Documentation

- [Parent Epic](./19-refactor-ansible-templates-variables-pattern.md)
- [Issue #19.1](./19.1-create-variables-template.md) - Must be completed first
- [Ansible vars_files Documentation](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#defining-variables-in-files)
- [Contributing: Templates](../contributing/templates.md)

## Notes

### Dependencies

- **Requires #19.1**: The `variables.yml` file must exist for this to work
- **Execution Order**: Run after #19.1 is merged

### Why This Order Is Safe

1. Phase 1-2: Create static file alongside Tera (both exist)
2. Phase 3-4: Update API incrementally (compilation catches all call sites)
3. Phase 5: Update firewall to use new approach (both templates still work)
4. Phase 6-7: Remove old infrastructure (static version proven working)
5. Phase 8: Final validation

### Testing Strategy

- **Unit Tests**: Verify all components compile and function
- **Config Tests**: Prove files copied correctly to build directory
- **Manual Verification**: Check file contents and structure
- **Full E2E Tests**: (Human reviewer only) Verify firewall works end-to-end

### Common Issues to Watch For

1. **Forgot to update call site**: Compilation will fail - good!
2. **Variables file not found**: Ensure #19.1 completed first
3. **Playbook not copied**: Check static registration
4. **Wrong argument syntax**: Use `&["-e", "@variables.yml"]` not `"-e @variables.yml"`
