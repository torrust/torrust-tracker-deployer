# Add AI-Discoverable Documentation Headers to Template Files

**Draft Issue** - To be created on GitHub after review

## Problem Statement

We use Tera templates for provisioning, configuring, and deploying services (Docker Compose, Caddy, Prometheus, Grafana, tracker config, etc.). These templates are:

1. **Source templates** in `templates/` - used during development
2. **Generated config files** in production installations - only the rendered output exists

We're refactoring template documentation to move it from template files to Rust wrapper types (doc.rs format). This improves documentation quality and ensures it's published with each release. However, this creates a **discoverability problem for AI agents** in two scenarios:

### Scenario 1: Development Time

AI agents working on the Tracker Deployer codebase have access to the full repo. They can search for documentation, but may not know where to look for the Rust wrapper that corresponds to a template file.

**Current state**: Template files have inline comments, but no pointer to the Rust wrapper.

### Scenario 2: Production Time (Critical)

AI agents helping administrators troubleshoot or modify deployed configurations only see the **rendered output files** - not the source repo. They have no way to find:

- What the original template was
- What configuration options exist
- What the valid values are
- Where to find documentation

**Example**: An admin asks an AI agent to help configure `docker-compose.yml` on a production server. The agent sees the rendered file but has no context about the template that generated it or the documentation for valid configurations.

## Proposed Solution

Add a standardized documentation header to all template files that provides:

1. **Repository URL** - Where to find the source code
2. **Template source path** - The original template file location
3. **Rust wrapper path** - The corresponding Rust context/wrapper module
4. **Documentation URL** - Link to docs.rs documentation for the wrapper
5. **Brief description** - What this template/config does

### Header Format (YAML-style comment block)

For YAML/TOML templates:

```yaml
# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/docker-compose/docker-compose.yml.tera
#   Rust Wrapper:  src/infrastructure/templating/docker_compose/template/wrappers/docker_compose/template.rs
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/torrust_tracker_deployer_lib/infrastructure/templating/docker_compose/template/wrappers/docker_compose/template/struct.DockerComposeTemplate.html
#
# DESCRIPTION:
#   Docker Compose service definitions for Torrust Tracker deployment.
#   Includes tracker, optional MySQL, Prometheus, Grafana, and Caddy services.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================
```

For TOML templates:

```toml
# ============================================================================
# Torrust Tracker Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/tracker/tracker.toml.tera
#   Rust Wrapper:  src/infrastructure/templating/tracker/template/wrapper/tracker_config/context.rs
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/torrust_tracker_deployer_lib/infrastructure/templating/tracker/template/wrapper/tracker_config/context/struct.TrackerContext.html
#
# DESCRIPTION:
#   Torrust Tracker configuration file. Controls tracker behavior, database,
#   UDP/HTTP trackers, and API endpoints.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================
```

## Templates to Update

| Template                                           | Rust Wrapper                                                                                |
| -------------------------------------------------- | ------------------------------------------------------------------------------------------- |
| `templates/docker-compose/docker-compose.yml.tera` | `src/infrastructure/templating/docker_compose/template/wrappers/docker_compose/template.rs` |
| `templates/docker-compose/.env.tera`               | `src/infrastructure/templating/docker_compose/template/wrappers/env/template.rs`            |
| `templates/tracker/tracker.toml.tera`              | `src/infrastructure/templating/tracker/template/wrapper/tracker_config/template.rs`         |
| `templates/caddy/Caddyfile.tera`                   | `src/infrastructure/templating/caddy/template/wrapper/caddyfile/` (needs template.rs)       |
| `templates/prometheus/prometheus.yml.tera`         | `src/infrastructure/templating/prometheus/template/wrapper/prometheus_config/template.rs`   |
| `templates/grafana/datasources.yml.tera`           | `src/infrastructure/templating/grafana/template/wrapper/datasource/template.rs`             |
| `templates/ansible/inventory.yml.tera`             | `src/infrastructure/templating/ansible/template/wrappers/inventory/template.rs`             |
| `templates/ansible/variables.yml.tera`             | `src/infrastructure/templating/ansible/template/wrappers/variables/template.rs`             |
| `templates/tofu/*/variables.tf.json.tera`          | Provider-specific wrappers in `src/infrastructure/templating/tofu/template/providers/`      |

## Benefits

### For AI Agents

1. **Immediate context** - Agent knows where to find documentation without searching
2. **Cross-environment support** - Works in development AND production
3. **Version-aware** - docs.rs links are versioned with releases
4. **Self-documenting** - Even without AI, humans can find relevant docs

### For Developers

1. **Clear mapping** - Easy to find the Rust wrapper for any template
2. **Consistent pattern** - All templates follow the same documentation structure
3. **Maintainability** - Single source of truth (Rust docs) with clear pointers

### For System Administrators

1. **Troubleshooting aid** - Know where to look for valid configuration options
2. **AI assistance** - AI agents can help with configuration knowing the constraints
3. **Version tracking** - Know which deployer version generated the config

## Implementation Considerations

### Header in Template vs. Rendered Output

The header should be in the **template file** so it appears in the **rendered output**. This ensures production configs include the documentation links.

### Dynamic vs. Static URLs

- Repository URL: Static (`https://github.com/torrust/torrust-tracker-deployer`)
- Template path: Static (relative path in repo)
- Rust wrapper path: Static (relative path in repo)
- docs.rs URL: Could include version from `Cargo.toml` or use `latest`

### Template Variables in Header?

Consider adding a version variable:

```yaml
# Version: {{ deployer_version }}
```

This would require passing the version to the template context.

## Related Documentation

- [Template System Architecture](../../docs/contributing/templates/template-system-architecture.md)
- [Tera Template Guide](../../docs/contributing/templates/tera.md)

## Open Questions

1. Should we include the deployer version in the header?
2. Should we add a "Generated at" timestamp?
3. Should we add a "Do not edit manually" warning?
4. For Ansible templates, should we use a different header format?

## Implementation Plan

1. Define the final header format
2. Update template rendering to include version if needed
3. Add headers to all template files
4. Verify headers appear in rendered output
5. Document the header format in contributing guide
