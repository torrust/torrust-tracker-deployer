# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/configure-firewall.yml
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Ansible playbook to configure UFW firewall rules for SSH access.
#   Ensures safe SSH connectivity before enabling firewall.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# IMPORTANT SECURITY NOTE:
# =======================
# This playbook ONLY configures SSH firewall rules. Application service ports
# (tracker, grafana, prometheus, etc.) are NOT controlled by UFW because Docker
# bypasses UFW rules when publishing container ports.
#
# Docker Security Model:
# - Docker manipulates iptables NAT table directly, bypassing UFW's INPUT/OUTPUT chains
# - Service exposure is controlled via docker-compose port bindings, not UFW
# - Internal services (MySQL, Prometheus) have NO port bindings - Docker network only
# - Public services (Tracker, Grafana) have explicit port bindings in docker-compose
#
# For details, see ADR: docs/decisions/docker-ufw-firewall-security-strategy.md
#
# This playbook configures UFW with restrictive policies while preserving SSH access.
# CRITICAL: SSH access is allowed BEFORE enabling firewall to prevent lockout.
#
# Variables are loaded from variables.yml for centralized management.

- name: Configure UFW firewall safely (SSH access only)
  hosts: all
  become: yes
  gather_facts: yes
  vars_files:
    - variables.yml

  tasks:
    - name: Install UFW (should already be present on Ubuntu)
      ansible.builtin.apt:
        name: ufw
        state: present
        update_cache: yes
      tags:
        - security
        - firewall
        - packages

    - name: Reset UFW to clean state
      community.general.ufw:
        state: reset
      tags:
        - security
        - firewall
        - reset

    - name: Set UFW default policy - deny incoming
      community.general.ufw:
        default: deny
        direction: incoming
      tags:
        - security
        - firewall
        - policy

    - name: Set UFW default policy - allow outgoing
      community.general.ufw:
        default: allow
        direction: outgoing
      tags:
        - security
        - firewall
        - policy

    # CRITICAL: Allow SSH BEFORE enabling firewall to prevent lockout
    - name: Allow SSH access on configured port (BEFORE enabling firewall)
      community.general.ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp
        comment: "SSH access (configured port {{ ssh_port }})"
      tags:
        - security
        - firewall
        - ssh

    - name: Enable UFW firewall (AFTER SSH rules are in place)
      community.general.ufw:
        state: enabled
      tags:
        - security
        - firewall
        - enable

    - name: Verify UFW status
      ansible.builtin.command:
        cmd: ufw status numbered
      register: ufw_status
      changed_when: false
      tags:
        - security
        - firewall
        - verification

    - name: Display UFW status
      ansible.builtin.debug:
        var: ufw_status.stdout_lines
      tags:
        - security
        - firewall
        - verification

    - name: Verify SSH port is allowed
      ansible.builtin.shell:
        cmd: "ufw status | grep -E '{{ ssh_port }}/tcp.*ALLOW'"
      register: ssh_port_check
      changed_when: false
      failed_when: ssh_port_check.rc != 0
      tags:
        - security
        - firewall
        - verification
        - ssh

    - name: Confirm firewall configuration complete
      ansible.builtin.debug:
        msg:
          - "UFW firewall configured successfully"
          - "SSH access preserved on port {{ ssh_port }}"
          - "Default policy: deny incoming, allow outgoing"
          - "Active rules protect against unauthorized access"
      tags:
        - security
        - firewall
