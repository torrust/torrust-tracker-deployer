# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/deploy-backup-config.yml
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Ansible playbook to deploy backup configuration files to remote host.
#   Copies rendered backup.conf and backup-paths.txt from build directory
#   to backup configuration directory.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# This playbook deploys backup configuration files to the remote host.
# The configuration files are copied from the local build directory to the
# backup configuration directory on the remote instance.
#
# Requirements:
# - Backup storage directories must already exist (created by create-backup-storage playbook)
# - Build directory must contain rendered backup.conf and backup-paths.txt
#
# Variables:
# - ansible_user: The SSH user for the remote host (set automatically)

- name: Deploy Backup configuration
  hosts: all
  become: true

  tasks:
    - name: Copy backup.conf to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../backup/etc/backup.conf"
        dest: /opt/torrust/storage/backup/etc/backup.conf
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy backup-paths.txt to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../backup/etc/backup-paths.txt"
        dest: /opt/torrust/storage/backup/etc/backup-paths.txt
        mode: "0644"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Verify backup.conf exists
      ansible.builtin.stat:
        path: /opt/torrust/storage/backup/etc/backup.conf
      register: backup_conf

    - name: Verify backup-paths.txt exists
      ansible.builtin.stat:
        path: /opt/torrust/storage/backup/etc/backup-paths.txt
      register: backup_paths

    - name: Assert backup configuration files were deployed
      ansible.builtin.assert:
        that:
          - backup_conf.stat.exists
          - backup_conf.stat.isreg
          - backup_conf.stat.pw_name == ansible_user
          - backup_paths.stat.exists
          - backup_paths.stat.isreg
          - backup_paths.stat.pw_name == ansible_user
        fail_msg: "Backup configuration files were not deployed properly"
        success_msg: "Backup configuration deployed successfully"
