# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/install-docker-compose.yml
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Ansible playbook to install Docker Compose v2 via direct download from GitHub releases.
#   Modern plugin-based installation optimized for reliability in E2E testing.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# This playbook installs Docker Compose v2 directly from GitHub releases,
# which is the most reliable method for getting the modern plugin-based version

- name: Install Docker Compose (Direct download for E2E)
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: üêã Starting Docker Compose installation
      debug:
        msg: |
          üöÄ Installing Docker Compose v2 via direct download on {{ inventory_hostname }}

    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Ensure Docker is installed
      fail:
        msg: "Docker must be installed before installing Docker Compose"
      when: docker_check.rc != 0

    - name: Create Docker CLI plugins directory
      file:
        path: /usr/local/lib/docker/cli-plugins
        state: directory
        mode: '0755'

    # Download with retries to handle transient network failures
    # Retries help prevent flaky E2E tests when GitHub or network is temporarily slow
    - name: Download Docker Compose v2 plugin
      get_url:
        url: "https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-linux-x86_64"
        dest: /usr/local/lib/docker/cli-plugins/docker-compose
        mode: '0755'
        timeout: 60
      retries: 3
      delay: 5
      register: download_result
      until: download_result is succeeded

    - name: Test Docker Compose installation
      command: docker compose version
      register: compose_version
      changed_when: false

    - name: üéâ Docker Compose installation completed
      debug:
        msg: |
          ‚úÖ Docker Compose installed successfully!
          Version: {{ compose_version.stdout }}
          Command: docker compose (modern plugin syntax)
