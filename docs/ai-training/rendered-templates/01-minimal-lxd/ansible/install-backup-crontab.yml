# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/install-backup-crontab.yml
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Ansible playbook to install backup crontab and maintenance script.
#   Copies the maintenance backup script and cron entry for scheduled backups.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# This playbook installs the backup crontab and maintenance script on the remote host.
# The crontab entry will automatically execute backups on the configured schedule.
#
# Requirements:
# - Backup configuration files must already be deployed (via deploy-backup-config playbook)
# - Build directory must contain rendered maintenance-backup.cron and maintenance-backup.sh
#
# Variables:
# - ansible_user: The SSH user for the remote host (set automatically)
#
# Behavior:
# - maintenance-backup.sh: Installed to /usr/local/bin/ with executable permissions
# - maintenance-backup.cron: Installed to /etc/cron.d/tracker-backup (requires root)
# - tracker-backup.log: Created in /var/log/ with proper permissions for logging

- name: Install backup crontab and maintenance script
  hosts: all
  become: true

  tasks:
    - name: Copy maintenance backup script to /usr/local/bin/
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../backup/etc/maintenance-backup.sh"
        dest: /usr/local/bin/maintenance-backup.sh
        mode: "0755"
        owner: root
        group: root

    - name: Copy maintenance backup cron to /etc/cron.d/
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../backup/etc/maintenance-backup.cron"
        dest: /etc/cron.d/tracker-backup
        mode: "0644"
        owner: root
        group: root

    - name: Create backup log file with proper permissions
      ansible.builtin.file:
        path: /var/log/tracker-backup.log
        state: touch
        mode: "0644"
        owner: root
        group: root

    - name: Verify maintenance-backup.sh exists
      ansible.builtin.stat:
        path: /usr/local/bin/maintenance-backup.sh
      register: maintenance_script

    - name: Verify maintenance-backup.cron exists
      ansible.builtin.stat:
        path: /etc/cron.d/tracker-backup
      register: crontab_entry

    - name: Verify tracker-backup.log exists
      ansible.builtin.stat:
        path: /var/log/tracker-backup.log
      register: backup_log

    - name: Assert backup crontab and script were installed
      ansible.builtin.assert:
        that:
          - maintenance_script.stat.exists
          - maintenance_script.stat.isreg
          - maintenance_script.stat.mode == "0755"
          - maintenance_script.stat.pw_name == "root"
          - crontab_entry.stat.exists
          - crontab_entry.stat.isreg
          - crontab_entry.stat.mode == "0644"
          - crontab_entry.stat.pw_name == "root"
          - backup_log.stat.exists
          - backup_log.stat.isreg
          - backup_log.stat.mode == "0644"
        fail_msg: "Backup crontab and script were not installed properly"
        success_msg: "Backup crontab and script installed successfully"
