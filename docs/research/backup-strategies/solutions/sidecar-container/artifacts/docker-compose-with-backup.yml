# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
# Generated: 2026-01-29T18:03:00Z
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/docker-compose/docker-compose.yml.tera
#   Rust Wrapper:  src/infrastructure/templating/docker_compose/template/wrappers/docker_compose/template.rs
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Docker Compose service definitions for Torrust Tracker deployment.
#   Includes tracker, optional MySQL, Prometheus, Grafana, and Caddy services.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

# IMPORTANT: Environment Variable Injection Pattern
#
# All configuration values that may need to be changed during maintenance
# should be injected via environment variables from the .env file, not
# hardcoded in this docker-compose template.
#
# Pattern to follow:
#   CORRECT:   - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
#   INCORRECT: - MYSQL_ROOT_PASSWORD=hardcoded_value
#
# Rationale:
# - System administrators can modify .env values and restart services without
#   regenerating templates
# - Supports runtime configuration changes without redeployment
# - Follows Docker Compose best practices for configuration management
# - Separates template generation (deploy-time) from configuration (runtime)
#
# See ADR: docs/decisions/environment-variable-injection-in-docker-compose.md

# Common service defaults (YAML anchor for DRY configuration)
x-defaults: &defaults
  tty: true
  restart: unless-stopped
  logging:
    options:
      max-size: "10m"
      max-file: "10"

services:

  tracker:
    <<: *defaults
    # TODO: Pin to stable v4.0.0 when released (currently using develop tag)
    # Tracking issue: https://github.com/torrust/torrust-tracker-deployer/issues/TBD
    # Rationale: The develop tag is mutable and introduces deployment non-reproducibility.
    #            Pinning to a stable release ensures predictable deployments and easier rollback.
    image: torrust/tracker:develop
    container_name: tracker
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      - USER_ID=1000
      - TORRUST_TRACKER_CONFIG_OVERRIDE_CORE__DATABASE__DRIVER=${TORRUST_TRACKER_CONFIG_OVERRIDE_CORE__DATABASE__DRIVER}
      - TORRUST_TRACKER_CONFIG_TOML_PATH=${TORRUST_TRACKER_CONFIG_TOML_PATH}
      - TORRUST_TRACKER_CONFIG_OVERRIDE_HTTP_API__ACCESS_TOKENS__ADMIN=${TORRUST_TRACKER_CONFIG_OVERRIDE_HTTP_API__ACCESS_TOKENS__ADMIN}
    networks:
      - metrics_network
      - database_network
    ports:
      # BitTorrent UDP announce
      - "6969:6969/udp"
      # HTTP tracker announce
      - "7070:7070"
      # HTTP API (stats/whitelist)
      - "1212:1212"
    volumes:
      - ./storage/tracker/lib:/var/lib/torrust/tracker:Z
      - ./storage/tracker/log:/var/log/torrust/tracker:Z
      - ./storage/tracker/etc:/etc/torrust/tracker:Z

  prometheus:
    <<: *defaults
    image: prom/prometheus:v3.5.0
    container_name: prometheus
    networks:
      - metrics_network
      - visualization_network
    ports:
      # Prometheus metrics (localhost only)
      - "127.0.0.1:9090:9090"
    # Grafana accesses Prometheus via Docker network: http://prometheus:9090
    # Host can access for validation via: curl http://localhost:9090
    volumes:
      - ./storage/prometheus/etc:/etc/prometheus:Z
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      - tracker

  grafana:
    <<: *defaults
    image: grafana/grafana:12.3.1
    container_name: grafana
    networks:
      - visualization_network
    ports:
      # Grafana dashboard
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
    volumes:
      - ./storage/grafana/data:/var/lib/grafana
      - ./storage/grafana/provisioning:/etc/grafana/provisioning:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      prometheus:
        condition: service_healthy

  mysql:
    <<: *defaults
    image: mysql:8.4
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    networks:
      - database_network
    # SECURITY: MySQL port is NOT exposed to the host/external network.
    # - Only the tracker container can access MySQL via Docker's internal database_network
    # - The healthcheck runs inside the container, so no external port is needed
    # - This prevents unauthorized external access to the database
    # See: https://github.com/torrust/torrust-tracker-deployer/issues/277
    volumes:
      - ./storage/mysql/data:/var/lib/mysql
    command: --mysql-native-password=ON
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =========================================================================
  # Backup Sidecar (PoC Phase 4)
  # =========================================================================
  # Backup container for proof of concept.
  # All behavior is controlled via environment variables - no rebuild needed.
  #
  # Public Interface (Environment Variables):
  #   BACKUP_INTERVAL      - Seconds between backups
  #   BACKUP_MYSQL_ENABLED - Enable MySQL database backup (true/false)
  #   BACKUP_PATHS_FILE    - Path to file listing config paths to backup
  #   MYSQL_*              - Database connection settings
  #
  # Mount Points:
  #   /backups - Output directory for all backups
  #   /data    - Source data (app storage, read-only)
  #   /config  - Backup configuration files (etc)
  #   /backups - Backup output directory (lib)
  #   /logs    - Backup logs (log)
  backup:
    <<: *defaults
    build:
      context: ./backup
      dockerfile: Dockerfile
    container_name: backup
    environment:
      # Backup schedule
      - BACKUP_INTERVAL=120
      # Retention policy (days to keep backups)
      - BACKUP_RETENTION_DAYS=7
      # MySQL backup settings
      - BACKUP_MYSQL_ENABLED=true
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # Config files backup settings
      - BACKUP_PATHS_FILE=/config/backup-paths.txt
    volumes:
      # Backup configuration (etc)
      - ./storage/backup/etc:/config:ro
      # Backup output directory (lib)
      - ./storage/backup/lib:/backups
      # Backup logs (log) - future use
      - ./storage/backup/log:/logs
      # Source data directory (read-only)
      - ./:/data:ro
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - database_network

# Networks are derived from service configurations in Rust code.
# See: src/domain/topology/network.rs for security rationale.

networks:
  # Database isolation: Tracker ↔ MySQL
  database_network:
    driver: bridge
  # Metrics scraping: Tracker ↔ Prometheus
  metrics_network:
    driver: bridge
  # Dashboard queries: Prometheus ↔ Grafana
  visualization_network:
    driver: bridge
