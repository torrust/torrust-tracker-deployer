# ============================================================================
# Torrust Tracker Deployer - Generated Configuration
# ============================================================================
#
# This file was generated by the Torrust Tracker Deployer.
#
# DOCUMENTATION:
#   Repository:    https://github.com/torrust/torrust-tracker-deployer
#   Template:      templates/ansible/init-tracker-database.yml
#   API Docs:      https://docs.rs/torrust-tracker-deployer/latest/
#
# DESCRIPTION:
#   Ansible playbook to initialize Torrust Tracker SQLite database.
#   Creates empty database file with proper ownership and permissions.
#
# For configuration options and valid values, see the API documentation link above.
# ============================================================================

---
# This playbook creates an empty SQLite database file for the Torrust Tracker.
# The database file is created with proper ownership and permissions.
#
# Requirements:
#   - The tracker storage directories must exist
#   - The ansible_user must have write access to /opt/torrust/storage/tracker/lib/database/
#
# Variables:
#   - ansible_user: The user that will own the database file (default: current user)
#
# Creates:
#   - /opt/torrust/storage/tracker/lib/database/tracker.db (SQLite database file)

- name: Initialize Tracker Database
  hosts: all
  become: true
  tasks:
    - name: Create empty SQLite database file
      ansible.builtin.file:
        path: /opt/torrust/storage/tracker/lib/database/tracker.db
        state: touch
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
        modification_time: preserve
        access_time: preserve

    - name: Verify database file exists
      ansible.builtin.stat:
        path: /opt/torrust/storage/tracker/lib/database/tracker.db
      register: db_file

    - name: Assert database file was created
      ansible.builtin.assert:
        that:
          - db_file.stat.exists
          - db_file.stat.isreg
          - db_file.stat.pw_name == ansible_user
        fail_msg: "Database file was not created properly"
        success_msg: "Database file created successfully"
