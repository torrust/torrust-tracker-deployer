---
# Configure Firewall for Tracker Services
# This playbook opens firewall ports for UDP trackers, HTTP trackers, and HTTP API.
# Must be run AFTER configure-firewall.yml (which sets up SSH access).
#
# Variables are loaded from variables.yml for centralized management.

- name: Configure firewall for Tracker services
  hosts: all
  become: true
  gather_facts: false
  vars_files:
    - variables.yml

  tasks:
    - name: Allow UDP tracker ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: udp
        comment: "Torrust Tracker UDP"
      loop: "{{ tracker_udp_ports }}"
      when: tracker_udp_ports is defined and tracker_udp_ports | length > 0
      tags:
        - security
        - firewall
        - tracker

    - name: Allow HTTP tracker ports
      community.general.ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
        comment: "Torrust Tracker HTTP"
      loop: "{{ tracker_http_ports }}"
      when: tracker_http_ports is defined and tracker_http_ports | length > 0
      tags:
        - security
        - firewall
        - tracker

    - name: Allow Tracker HTTP API port
      community.general.ufw:
        rule: allow
        port: "{{ tracker_api_port }}"
        proto: tcp
        comment: "Torrust Tracker HTTP API"
      when: tracker_api_port is defined
      tags:
        - security
        - firewall
        - tracker
        - api

    - name: Reload UFW to apply changes
      community.general.ufw:
        state: reloaded
      tags:
        - security
        - firewall
        - reload
