---
# Run Docker Compose Services Playbook
# Starts the Docker Compose application stack on the remote host

- name: Run Docker Compose Services
  hosts: all
  gather_facts: false
  become: true

  vars:
    deploy_dir: /opt/torrust

  tasks:
    - name: üöÄ Starting Docker Compose services
      ansible.builtin.debug:
        msg: "Starting Docker Compose services in {{ deploy_dir }}"

    - name: Verify docker-compose.yml exists
      ansible.builtin.stat:
        path: "{{ deploy_dir }}/docker-compose.yml"
      register: compose_file_check

    - name: Fail if docker-compose.yml not found
      ansible.builtin.fail:
        msg: |
          docker-compose.yml not found at {{ deploy_dir }}/docker-compose.yml

          Please run the 'release' command first to deploy Docker Compose files:
            cargo run -- release <environment>
      when: not compose_file_check.stat.exists

    - name: Verify .env file exists
      ansible.builtin.stat:
        path: "{{ deploy_dir }}/.env"
      register: env_file_check

    - name: Fail if .env file not found
      ansible.builtin.fail:
        msg: |
          .env file not found at {{ deploy_dir }}/.env

          Docker Compose requires a .env file with environment variables.
          Please run the 'release' command first to deploy the .env file:
            cargo run -- release <environment>

          For more information, see:
          https://docs.docker.com/compose/how-tos/environment-variables/set-environment-variables/#use-the-env_file-attribute
      when: not env_file_check.stat.exists

    - name: Pull Docker images
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ deploy_dir }}"
      register: pull_result
      changed_when: "'Pulled' in pull_result.stdout or 'Downloaded' in pull_result.stdout"
      failed_when: pull_result.rc != 0

    - name: Start Docker Compose services
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ deploy_dir }}"
      register: compose_up_result
      changed_when: "'Started' in compose_up_result.stderr or 'Creating' in compose_up_result.stderr"
      failed_when: compose_up_result.rc != 0

    - name: Wait for services to be healthy
      ansible.builtin.command:
        cmd: docker compose ps --format json
        chdir: "{{ deploy_dir }}"
      register: compose_status
      retries: 30
      delay: 2
      until: >
        (compose_status.stdout | from_json | selectattr('Health', 'defined') | list | length == 0) or
        (compose_status.stdout | from_json | selectattr('Health', 'defined') | selectattr('Health', 'equalto', 'healthy') | list | length ==
         compose_status.stdout | from_json | selectattr('Health', 'defined') | list | length)
      changed_when: false
      ignore_errors: true

    - name: Get running containers status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ deploy_dir }}"
      register: final_status
      changed_when: false

    - name: Display service status
      ansible.builtin.debug:
        msg: |
          ‚úÖ Docker Compose services started!
          üìÅ Working directory: {{ deploy_dir }}

          Container status:
          {{ final_status.stdout }}
